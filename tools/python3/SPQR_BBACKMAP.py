
import argparse
import sys
import scipy
from math import sqrt
from scipy.spatial.transform import Rotation
import numpy as np


parser=argparse.ArgumentParser()
refflag=False
parser.add_argument("-i","--input", help="Input file",type=str,default="")
parser.add_argument("-o","--output", help="Output file",type=str,default="mul_output.pdb")
parser.add_argument("-A","--atreference", help="Reference atomistic pdb file",type=str,default="")
parser.add_argument("-C","--cgreference", help="Reference spqr pdb file",type=str,default="")
args=parser.parse_args()

NATNT=5

###########################DATA##########################
TEMPL_A_A3=["P	-6.207395636331726	-4.363997760912843	0.7389665539851726	",
            "OP1	-6.76928512838613	-5.561525532423607	1.4237624616681208",	
            "OP2	-6.64965293933796	-3.0099125129668436	1.1368354007584243",	
            "O5'	-4.62971309837886	-4.439896727243076	0.8652802759183171",	
            "C5'	-3.962829313743843	-5.6469440737565115	0.5631234936582683",	
            "C4'	-2.4864406987519465	-5.4146875307950495	0.4918524913226746",	
            "O4'	-2.2382950656731806	-4.364929913819654	-0.4698364866666106",	
            "C3'	-1.8121997967472443	-4.946067510528526	1.7654091185164913",	
            "O3'	-1.4824669458668296	-6.108604910219533	2.5203853044786335",	
            "C2'	-0.568625567143949	-4.259129192958919	1.2094011299756815",	
            "O2'	0.4328973461816232	-5.185274359638217	0.8379001416587996",	
            "C1'	-1.1041730997766301	-3.630490406184873	-0.08116313268399161",	
            "N9	-1.4686382876369568	-2.2141608044469723	-0.024175536850355006	",
            "C8	-2.7224817885796755	-1.65644783660289	-0.01508044794184027	",
            "N7	-2.718927525944968	-0.3461328420317105	-0.005754022096204348	",
            "C5	-1.3715520356165478	-0.019501056827352398	-0.00001251040866251385	",
            "C6	-0.7014616493919442	1.210996352407161	5.551115123125783e-17	",
            "N6	-1.317109971480314	2.3970054126499383	-0.004318857699186385	",
            "N1	0.6485875199262835	1.18751559112607	0.0037275022203413777	",
            "C2	1.2684768863133018	-2.498001805406602e-16	-5.551115123125783e-17	",
            "N3	0.7489996767218169	-1.2200938265899302	-0.001866288345382494	",
            "C4	-0.5930503979529513	-1.158917060115947	-0.0018487034662834079	"]

TEMPL_A_A2=["P	-5.753209138229119	-4.79206525518805	0.27301675087956045	",
            "OP1	-5.753756397142149	-3.4847317526440804	-0.43592951904065813	",
            "OP2	-6.606004631123836	-5.897877277041239	-0.22897390602893686	",
            "O5'	-4.244892329237568	-5.296893357963497	0.3335063397497946	",
            "C5'	-3.6258128673861942	-5.894228108351645	-0.8167465958659057	",
            "C4'	-2.140210517824583	-5.616231881342697	-0.8228912476713002	",
            "O4'	-1.8925261983276644	-4.219496289252191	-1.1516923481301378	",
            "C3'	-1.4073325602221949	-5.876980910675131	0.48783711585897505	",
            "O3'	-0.07461383039136904	-6.277228061407606	0.19195030390439277	",
            "C2'	-1.3577357615658165	-4.487110132397049	1.1121121972547576	",
            "O2'	-0.2877781965198414	-4.356269251078729	2.0205027920853884	",
            "C1'	-1.1163149390696532	-3.6289234337961966	-0.12896619543840582	",
            "N9	-1.4803948396506983	-2.2156718240993234	-0.030073760530107296	",
            "C8	-2.7327314560806144	-1.6540755469132624	0.011006899148141236	",
            "N7	-2.7242919127905956	-0.34324034460461944	0.028265128997043698	",
            "C5	-1.3745013552281455	-0.018386564637867975	0.009411154440879616	",
            "C6	-0.6966376790246454	1.2160413460381467	-1.3877787807814457e-17	",
            "N6	-1.310121743224383	2.400307317001369	-0.016745536465293864	",
            "N1	0.6527902260238835	1.1894652133094348	0.0001955647036340491	",
            "C2	1.2702701593668102	5.551115123125783e-17	0.	",
            "N3	0.7450942128060589	-1.2235165281775768	-0.00644441078120038",	
            "C4	-0.5970155639439487	-1.1636034665321349	-0.003162308363323915"]	

TEMPL_A_H3=["P	-4.186389451494258	-4.0197625445340535	-3.8603370321170587",	
            "OP1	-4.897549872305843	-5.297557725458844	-3.5958520013941997	",
            "OP2	-4.880309932788658	-2.7325838459957135	-3.60130930450996	",
            "O5'	-2.805893800911086	-4.015317071824198	-3.061557340028365	",
            "C5'	-2.003309696824977	-5.196254221024629	-2.938316902238362	",
            "C4'	-1.4556277715281896	-5.282657976444391	-1.534761452762796	",
            "O4'	-0.7990918311901969	-4.023807194655096	-1.2730913011730771	",
            "C3'	-2.5486206354445464	-5.414616246627966	-0.4788639130563721	",
            "O3'	-2.7704331133187177	-6.779107621559437	-0.06451440793184626	",
            "C2'	-2.0355216527552007	-4.590437691469029	0.706201546392718	",
            "O2'	-1.3560623282291837	-5.337518446581803	1.692625578771682	",
            "C1'	-1.0640693265543102	-3.611013861800023	0.04696005816903592	",
            "N9	-1.4729078350318439	-2.212458322877455	0.015456430840269708	",
            "C8	-2.726540094610339	-1.6603756235765266	0.0037581028945155026	",
            "N7	-2.723541285556669	-0.3502109130097227	-0.007793448068963649	",
            "C5	-1.3750037345710393	-0.019878194369110147	-0.004220133475933641	",
            "C6	-0.699691604306032	1.209818807818984	-2.7755575615628914e-17	",
            "N6	-1.3167014842532323	2.391004528626707	0.007752483955426492	",
            "N1	0.6513199969299082	1.186038779678212	0.0004044595471208168	",
            "C2	1.2710601436945792	-2.0816681711721685e-16	2.220446049250313e-16	",
            "N3	0.7475297112695298	-1.2187911985691324	0.001974997535094891	",
            "C4	-0.5952145130169688	-1.1571881945589544	0.0018406763936815729	"]

TEMPL_A_H2=["P	-5.09034188921764	-5.219621531074311	-2.3797755136659346",	
            "OP1	-5.200162737994526	-6.567309330247818	-1.7779225605845412	",
            "OP2	-6.0568091881245865	-4.16949637408978	-1.9907226704534475	",
            "O5'	-3.611306649510448	-4.693553790113413	-2.1199130661584347	",
            "C5'	-2.4716021854363888	-5.464356727687603	-2.5382401702249395	",
            "C4'	-1.3965540871273743	-5.4119393138532255	-1.4822396962434687	",
            "O4'	-0.9473533116217334	-4.0414859428995555	-1.3329841391380057	",
            "C3'	-1.8361275392338192	-5.872754223241666	-0.09762068745854413	",
            "O3'	-0.7092258214745025	-6.446195405321955	0.5518712133419517	",
            "C2'	-2.1688369414056483	-4.561541824880732	0.6055951400731099	",
            "O2'	-2.047468075482745	-4.626118704926223	2.010953964341198	",
            "C1'	-1.1178424718007274	-3.6281435664742223	0.0060642267220561985	",
            "N9	-1.4827329967770027	-2.2115997604891984	0.003316407949621736	",
            "C8	-2.7373162850401194	-1.6482110607613047	0.002343870123148406	",
            "N7	-2.724907140699025	-0.33846593709812794	-0.00043537028672679945	",
            "C5	-1.3750274800855569	-0.01631661640980331	0.00041141309501291357	",
            "C6	-0.6993688641566201	1.2123388542003561	2.7755575615628914e-17	",
            "N6	-1.319411377033748	2.391586086732513	0.0036396140279336686	",
            "N1	0.6548311122261116	1.187677679172687	-0.0005004110664134642	",
            "C2	1.2715891522902416	-3.3306690738754696e-16	5.551115123125783e-17	",
            "N3	0.745946364709976	-1.2237963510188739	-0.0003887129331358319	",
            "C4	-0.597970284984178	-1.1599035659443702	0.000477710904525086	"]

TEMPL_A_S3=["P	2.192425283659036	-3.9532699339500823	4.338052588484198               ",	
            "OP1	1.530515762940257	-4.528980135749267	5.5590409381117425	",
            "OP2	3.64617480988985	-4.100658746088307	4.079387064998423	",
            "O5'	1.4542346151067287	-4.624609870956242	3.115217266029517	",
            "C5'	1.7538156807163316	-4.260409824716516	1.786434924392188	",
            "C4'	0.632344310545516	-4.679042227219153	0.8908469178500674	",
            "O4'	-0.5362534070349011	-3.9258917249735577	1.2273148887374015	",
            "C3'	0.850225413700929	-4.412642489463969	-0.5786948490323008	",
            "O3'	1.5818712226974578	-5.465644104732008	-1.1616082288930794	",
            "C2'	-0.561859929216477	-4.256170960204641	-1.1211426758774996	",
            "O2'	-1.1658989415228516	-5.518134751727021	-1.3678940902572316	",
            "C1'	-1.2894009464333684	-3.651598655652543	0.07505229018596572	",
            "N9	-1.5359747159641732	-2.199311552805621	0.017741321917552677	        ",
            "C8	-2.7599084946920796	-1.6219134564490212	0.055391602296257614	        ",
            "N7	-2.734414316646816	-0.31689776707514283	0.04921929528718283             ",
            "C5	-1.3826365558100573	-0.007284236667486316	0.004337816973156383            ",
            "C6	-0.6840432248561652	1.2086070172243464	0.	                        ",
            "N6	-1.2775612022890765	2.394854100249967	-0.000518147800849	        ",
            "N1	0.667246236032444	1.1932454487450825	-0.008112650938105231	        ",
            "C2	1.2802923060336238	-1.3877787807814457e-16	0.	                        ",
            "N3	0.7346712031745894	-1.2335117184517697	0.00821295056914545	",
            "C4	-0.6155299645744149	-1.1610565108501723	-0.004438116604157896	"]

TEMPL_A_S2=["P	3.660414798182133	-3.6436622260093214	1.01413856668926",	
            "OP1	3.9750074015902674	-2.352943663237256	0.37000885491025226	",
            "OP2	4.576309186501438	-4.787269843009255	0.8107913567626908	",
            "O5'	2.1843550806443095	-4.073164650329537	0.6479837117914372	",
            "C5'	1.5475221649601365	-5.123246418151499	1.3487448111606126	",
            "C4'	0.12716566022909825	-5.3008788131692555	0.9005616658857571	",
            "O4'	-0.6281792748654322	-4.081923386595234	1.1772613172277804	",
            "C3'	-0.05494455910340024	-5.576758575111068	-0.5951536228525777	",
            "O3'	-1.2171722152270812	-6.388778440338815	-0.760234251082464	",
            "C2'	-0.3485208828166776	-4.1833575763490245	-1.1287036193889257	",
            "O2'	-0.9809034487520902	-4.15877757550302	-2.3868399847561137	",
            "C1'	-1.2589989948498734	-3.6729376051477365	-0.01858738200324253	",
            "N9	-1.4787866727167471	-2.214292761696066	0.001576876716919029	",
            "C8	-2.723589059333374	-1.6125297251177768	-0.008132195413032894	",
            "N7	-2.7173113272878906	-0.3015287251809348	-0.005309387420080025	",
            "C5	-1.3679381711192624	-0.011844768968305414	0.00037312298442981895	",
            "C6	-0.7078741425506483	1.2201545569117946	-5.551115123125783e-17	",
            "N6	-1.3628725899289438	2.382213653708042	-0.002385264160114531	",
            "N1	0.6462502602859123	1.1933762421619196	-0.00015330250842962578",	
            "C2	1.2651065611683174	2.7755575615628914e-17	0.	",
            "N3	0.752759996937849	-1.2339427626726849	-0.0005065263446090706	",
            "C4	-0.5883045047221638	-1.1677432674327293	0.0002867058686339824	"]

TEMPL_C_A3=["P	-3.385317312675631	-4.55677907300238	0.5830587974082008	",
            "OP1	-3.6777542326910098	-5.851074522221549	1.2249014089123482	",
            "OP2	-4.160672834392856	-3.345551272988711	0.9504931880368657	",
            "O5'	-1.8333744807272332	-4.176897425275268	0.7249650343539835	",
            "C5'	-0.8324102197915578	-5.154607479886798	0.4150124614641614	",
            "C4'	0.5372589404145001	-4.5177807144501	0.46524255606762743	",
            "O4'	0.5798982067148498	-3.4780973885774973	-0.5389932105090561	",
            "C3'	0.8828256951801305	-3.778006051763658	1.7523905920168337	",
            "O3'	1.3389092294291394	-4.624830821338273	2.7904958946821448	",
            "C2'	1.978082875677506	-2.8527299819298886	1.2496929660408258	",
            "O2'	3.214298137097403	-3.526571331772764	1.0341108177203346	",
            "C1'	1.4212025737210694	-2.43767377288411	-0.08210081402628855	",
            "N1	0.6424873674010932	-1.1890842632404657	-0.019748076685550175	",
            "C2	1.3912020182401859	-1.6653345369377348e-16	0.	                " ,
            "O2	2.645335477740945	-0.019042379351737193	0.00875520126998608	",
            "N3	0.7039732854861882	1.1649898298982844	-0.009968204999184077	",
            "C4	-0.6222612530466092	1.192568511733844	5.551115123125783e-17	",
            "N4	-1.2285816548338988	2.37811141887794	-0.00579531680169354	",
            "C5	-1.3928264328537743	-0.0028568861760358277	0.022481585815112726	",
            "C6	-0.7225749852270736	-1.1656171922156353	0.007234695869600377	"]

TEMPL_C_A2=["P	-2.872544452937599	-5.089647187257409	0.14331332273547226 "	,
            "OP1	-3.106419382492172	-6.456236597175841	0.6813076554422719	",
            "OP2	-3.644769902760866	-3.9423028302782956	0.6867604509397098	",
            "O5'	-1.3190117104093613	-4.756282545633285	0.2626156010352565	",
            "C5'	-0.37347131077435347	-5.395089432704732	-0.589173171893894	",
            "C4'	0.9651567239586238	-4.693645241564756	-0.5283124181775735	",
            "O4'	0.8227286077209244	-3.3151146737721486	-0.969516118713253	",
            "C3'	1.6303462550738623	-4.633670929922735	0.8415689524665221	",
            "O3'	3.031855700044135	-4.780965715160244	0.6834249614299727	",
            "C2'	1.323496686455365	-3.2187169395200295	1.3095417586017737	",
            "O2'	2.301298283214524	-2.7321016139112055	2.205650882680898	",
            "C1'	1.3952308183043582	-2.457202622270629	-0.006562780920850719	",
            "N1	0.6495325873819567	-1.1914302687232663	-0.001224485840744638	",
            "C2	1.3733629648906853	2.7755575615628914e-17	-1.1102230246251565e-16	",
            "O2	2.614597227241978	-0.05623555740793909	-0.00026086064087915695	",
            "N3	0.7093978005619364	1.1792429303873389	0.00117119143480382	",
            "C4	-0.6239310766629949	1.1926120540956127	5.551115123125783e-17	",
            "N4	-1.2337110023458737	2.381063221352472	-0.0036421532074336627	",
            "C5	-1.390414296013867	-0.010033317494256982	0.0007646221203660986	",
            "C6	-0.717947980157706	-1.170391398265418	-0.0007113277143968311"]

TEMPL_C_H3=["P	-2.0701818379414747	-3.658969902509335	-3.6007412769763634"	,
            "OP1	-2.622203430799283	-4.985296270245095	-3.9663866342114735	",
            "OP2	-2.9700223857987815	-2.4882343471675865	-3.494504523023192	",
            "O5'	-1.29190185409376	-3.810716796226643	-2.227239494309468	",
            "C5'	-0.24909363059795037	-4.759587019550152	-2.10014382837427	",
            "C4'	0.6014292861209922	-4.440831246539025	-0.9015540214311373	",
            "O4'	1.2769872263680049	-3.1708181867080354	-1.1240383966756562	",
            "C3'	-0.16663070997863583	-4.205418777758252	0.3879876847319379	",
            "O3'	-0.5670677938225059	-5.4030261480921205	1.035437859189103	",
            "C2'	0.8249700342880993	-3.378843537288319	1.190219780706492	",
            "O2'	1.8593869438530746	-4.185595475294798	1.7192594462598683	",
            "C1'	1.399794580331858	-2.4693744286359043	0.10367126284244454	",
            "N1	0.6541624808606735	-1.1944537297405247	0.017787715137892346	",
            "C2	1.373126238430638	-2.7755575615628914e-16	0.	                ",
            "O2	2.610676935353814	-0.04974670171606621	-0.009671515565415123	",
            "N3	0.7049541206832757	1.1806581038421602	-0.00731183265912097	",
            "C4	-0.6270224658906982	1.1945832581288218	0.	                ",
            "N4	-1.2369833783633841	2.3838795767935306	0.018081804834319648	",
            "C5	-1.3901538061411762	-0.009423370661458902	-0.005620974699549697	",
            "C6	-0.7150665679426984	-1.1713642615690054	-0.004854907779197393	"]

TEMPL_C_H2=["P	-2.2681563214805767	-5.09428574355861	-1.529368977669788"	,
            "OP1	-2.368566966198757	-6.573328872349911	-1.5785027298419898	",
            "OP2	-3.3317846765154946	-4.30689408470384	-0.8487699048437652	",
            "O5'	-0.848286547712245	-4.7256418523334	-0.9042437846073141	",
            "C5'	0.3466684032451632	-5.102602017221268	-1.5842825329666181	",
            "C4'	1.5652257997557697	-4.493670454851604	-0.9216052180090898	",
            "O4'	1.5570476396018909	-3.0525454946147583	-1.1019658752457824	",
            "C3'	1.530195880216583	-4.724335492788958	0.5945809661419321	",
            "O3'	2.8024194024078337	-5.0709213291456985	1.1192023225697594	",
            "C2'	0.9998675316983091	-3.438614813638666	1.2066505520250996	",
            "O2'	1.7142115252347194	-3.0910625353980685	2.368895394039134	",
            "C1'	1.4100879397256298	-2.425434536791408	0.14664963530587083	",
            "N1	0.6479707529587572	-1.1875632308736381	0.028658010094638253	",
            "C2	1.3728026583922712	-1.942890293094024e-16	-1.1102230246251565e-16	",
            "O2	2.616247584408894	-0.06835320481169477	-0.02513076511944745	",
            "N3	0.7126739104910195	1.1797474362775149	-0.007212682646336288	",
            "C4	-0.6251635580670689	1.1907422046300122	1.1102230246251565e-16	",
            "N4	-1.2415720137861799	2.371377882501334	0.028124932983176754	",
            "C5	-1.389479531368585	-0.012228083805976814	-0.014442233081768285	",
            "C6	-0.7188042324063892	-1.1706983262279151	-0.007003094366539148	"]

TEMPL_G_A3=["P	-6.19822454911301	-4.2883356809927236	0.8054314911949942	",
            "OP1	-6.875506440552226	-5.358289673659751	1.5803041859677562	",
            "OP2	-6.571329085871343	-2.869355194249898	1.0429865014419781	",
            "O5'	-4.619527505140285	-4.437499915385678	0.9586851193078176	",
            "C5'	-3.9664773405833476	-5.656311436627335	0.6469962387542221	",
            "C4'	-2.474557040517617	-5.403276556901263	0.6357637904995592	",
            "O4'	-2.1637027973840937	-4.440968305653133	-0.40031413567475016	",
            "C3'	-1.9255741846364145	-4.722916480037955	1.882108040600255	",
            "O3'	-1.7637651486320478	-5.626184042194308	2.9678006983185754	",
            "C2'	-0.608588261783899	-4.161059986454031	1.364796374748929	",
            "O2'	0.4003588283726359	-5.1458847647109955	1.2373643324840917	",
            "C1'	-1.0510422671238102	-3.654192900947939	-0.004011212455800911	",
            "N9	-1.4299035588630573	-2.240489345102531	0.00003573846047535967	",
            "C8	-2.698050731784896	-1.709492069839857	-0.0023394402619179577	",
            "N7	-2.7235693673904042	-0.40468805057311535	-0.002859576963252508	",
            "C5	-1.3816195455358553	-0.04187734656736489	-0.002597501790354617	",
            "C6	-0.7722711471599488	1.2402302083519432	0.	                ",
            "O6	-1.3181131688495393	2.349890291192901	0.0039984881166662545	",
            "N1	0.6166463320200907	1.1717480794123563	0.0018531173913891794	",
            "C2	1.330060660688491	-3.174543961037557e-16	0.	                ",
            "N2	2.6606919511570055	0.13084303654078056	0.005046643923043215	",
            "N3	0.7815673814754222	-1.2101566766988698	0.000969793401319502	",
            "C4	-0.5743836814882048	-1.159944264498061	-0.00022540900234070682	"]

TEMPL_G_A2=["P	-5.911686804942432	-4.766847050792538	0.351991292755345",	
            "OP1	-6.271390230647997	-6.103909387147243	0.9032142551193763	",
            "OP2	-6.1672515283546225	-3.539728674937269	1.143660519001751	",
            "O5'	-4.354128428832922	-4.7514309324060635	0.038599767175928834	",
            "C5'	-3.698933473842802	-5.738916716172362	-0.7476014779356244	",
            "C4'	-2.211311226159333	-5.635769141574744	-0.5686220767414922	",
            "O4'	-1.7665584589423489	-4.330527895648135	-1.0196101763458996	",
            "C3'	-1.7054092742622045	-5.719667226710803	0.8611563418874838	",
            "O3'	-0.407526583604325	-6.254880159451358	0.9193683502527438	",
            "C2'	-1.6358993492503258	-4.278058056207524	1.2991955751140143	",
            "O2'	-0.8006982326936619	-4.072494133314366	2.4159822908781656	",
            "C1'	-1.104321392962906	-3.6422065644172856	0.008707777117687554	",
            "N9	-1.427477625784485	-2.225511165331149	-0.0067258030482564846	",
            "C8	-2.7078214456629923	-1.7106786663854185	-0.006277552889373594	",
            "N7	-2.7170526014180245	-0.40375133646350686	-0.014568515837461493	",
            "C5	-1.3807283137336193	-0.04218919548015407	-0.002069861817871166	",
            "C6	-0.7774548893398523	1.2383602534253826	2.7755575615628914e-17	",
            "O6	-1.3347736309355704	2.3403964465693234	-0.00592024213834777	",
            "N1	0.6109004812269415	1.1633583880516392	0.008067540443067178	",
            "C2	1.3326969731421396	-1.1796119636642288e-16	-2.7755575615628914e-17	",
            "N2	2.66928388616978	0.13264586249434956	0.005338453556304468	",
            "N3	0.7841834340066629	-1.203994445137571	-0.007698926090525263	",
            "C4	-0.5695976853022751	-1.1555350008593035	0.001701247465364153"]

TEMPL_G_H3=["P	-4.125612782821615	-4.369411035694682	-3.8435263691955805"	,
            "OP1	-4.582937657437317	-5.6669628063430695	-4.365444333577883	",
            "OP2	-5.048504874270561	-3.2330577661498183	-3.6635223849738834	",
            "O5'	-3.530020093296378	-4.600768017875352	-2.38050849678925	",
            "C5'	-2.7158406529064534	-5.7290024792958905	-2.1991253693780624	",
            "C4'	-1.8640962208494045	-5.513065374869385	-0.9762559612270093	",
            "O4'	-1.120970460600762	-4.282637574034105	-1.1574562133972002	",
            "C3'	-2.631266566127347	-5.257661178551371	0.3129330698422416	",
            "O3'	-2.9183221309188805	-6.485239001419197	0.9549064271751597	",
            "C2'	-1.6220790574551083	-4.479142999728426	1.1423063377874572	",
            "O2'	-0.6770270830532474	-5.317267121331022	1.789459119182256	",
            "C1'	-0.9588575013557871	-3.6264225703685247	0.07203158947398637	",
            "N9	-1.4288494809672831	-2.228903461892339	0.038180732102319676	",
            "C8	-2.7114152660959956	-1.6943007089897288	0.024656553527130975	",
            "N7	-2.7331429443412345	-0.3868387830339079	0.001285199822974037	",
            "C5	-1.3848573319709718	-0.040654050587780516	-0.009486916800664047	",
            "C6	-0.7639145820360516	1.239076038029689	-2.7755575615628914e-17	",
            "O6	-1.324160839202152	2.336259885424147	-0.008045890135348815	",
            "N1	0.6179162561264654	1.1739510817365524	-0.011012482503891682	",
            "C2	1.3354011569562119	1.6653345369377348e-16	2.7755575615628914e-17	",
            "N2	2.668104435465021	0.12655475787384263	-0.00984198716600776	",
            "N3	0.7768764798471806	-1.2187530054022273	0.004505206242807092	",
            "C4	-0.5814219789228411	-1.1536200637762355	0.015994193061755327	"]

TEMPL_G_H2=["P	-5.046079127323482	-4.917858295353359	-1.9353956973684194"	,
            "OP1	-5.310168208155586	-6.343727890753481	-1.6138714303235338	",
            "OP2	-5.770620826812822	-3.8701619010799697	-1.1966524462130255	",
            "O5'	-3.5006611874615245	-4.620220094561044	-1.888269350364481	",
            "C5'	-2.5485360570191258	-5.623610131421828	-2.215879133351129	",
            "C4'	-1.3638891267215898	-5.530059534422125	-1.2910429660557394	",
            "O4'	-0.8970587115494731	-4.15262482619497	-1.281245617363631	",
            "C3'	-1.6856089289991778	-5.877440668664811	0.1627605682619957	",
            "O3'	-0.4912386302637357	-6.364970171669594	0.7670747027967728	",
            "C2'	-2.0360945898544722	-4.511624475313707	0.7443196172971984	",
            "O2'	-1.930626591485826	-4.3928400691688605	2.1449604585469912	",
            "C1'	-1.011333727565444	-3.6347182046654787	0.031711332460111596	",
            "N9	-1.404737000023073	-2.22682640194997	-0.005484595624847599	",
            "C8	-2.6887099219886283	-1.72384055398764	0.015076834501726255	",
            "N7	-2.7231544372141894	-0.41607519003671656	0.00888585548504417	",
            "C5	-1.384618056437211	-0.04666385684302096	0.007611396959929628	",
            "C6	-0.7976045380046379	1.235471547790095	0.	                ",
            "O6	-1.3837995877218177	2.3268321735648114	-0.005034699165954226	",
            "N1	0.6011680977761542	1.163018430685685	-0.010938885350776528	",
            "C2	1.3366424145763327	-2.0816681711721685e-16	0.	                ",
            "N2	2.6681602141448764	0.11602679664529358	-0.00656748752300107	",
            "N3	0.8005626132877278	-1.2032868623316848	0.0014743101235666356	",
            "C4	-0.5561505311983634	-1.1485392593010773	0.0018531782672816521	"]

TEMPL_G_S3=["P	2.508974531608025	-3.8596018015314093	4.262317680691525"	,
            "OP1	1.8102275957334713	-4.201594680721629	5.530410575628287	",
            "OP2	3.893521006658111	-4.336357952672698	4.00137969806858	",
            "O5'	1.5728032071935605	-4.348258643534394	3.0672269970579626	",
            "C5'	1.9800845936130416	-4.215122296248774	1.7133973972531462	",
            "C4'	0.8734363525253928	-4.6237725377849905	0.7732529133625025	",
            "O4'	-0.35729523011659403	-3.953789718788735	1.1412349696334212	",
            "C3'	1.0790676376746346	-4.277687472993229	-0.6949929456461152	",
            "O3'	1.8507752201354744	-5.266280800505737	-1.3532874389925182	",
            "C2'	-0.3460728085048036	-4.17891051040908	-1.2317860345790144	",
            "O2'	-0.8289993191152838	-5.462888535386992	-1.5908896640836532	",
            "C1'	-1.124690437490043	-3.6845494439686277	-0.006690232683809569	",
            "N9	-1.4316782575017795	-2.2396886269608967	-0.0261246825137898	",
            "C8	-2.699454278265559	-1.7036051447260356	-0.014968462217649914	",
            "N7	-2.718646458059456	-0.39843944890578137	-0.010052499566150869	",
            "C5	-1.3766719573049846	-0.04379045428102733	-0.0046183541457906485	",
            "C6	-0.7801959646973071	1.2433028061502713	0.	                ",
            "O6	-1.3397848475333227	2.345182952814198	0.004292387939987222	",
            "N1	0.6070759484435581	1.1665905595778583	0.008536406520998484	",
            "C2	1.3305506170170502	2.0122792321330962e-16	0.	                ",
            "N2	2.6681665212182097	0.12870814466738956	0.011657886789443184	",
            "N3	0.7841347267069662	-1.2034409198345961	0.000792012814762405	",
            "C4	-0.5648933701652543	-1.1626619916125043	-0.004710065189970296"]

TEMPL_G_S2=["P	3.793633299360761	-3.8420257440139087	1.1600359860720695"	,
            "OP1	4.613550059434331	-5.069947176152536	0.9737339113517647	",
            "OP2	4.115221784146051	-2.5910043884010046	0.42754201732286945	",
            "O5'	2.2856957580808883	-4.164324647479812	0.7804667717995165	",
            "C5'	1.5930103771185316	-5.264977916963867	1.3502907300314366	",
            "C4'	0.20073742824514343	-5.362851154631488	0.789297089083647	",
            "O4'	-0.5568248827403914	-4.159423070024277	1.1244615116479664	",
            "C3'	0.13439963061827426	-5.4943763780703465	-0.7366968205389877	",
            "O3'	-0.9191498980661367	-6.38112034425321	-1.094556470467757	",
            "C2'	-0.23969796998659482	-4.084997068494638	-1.172971902295415	",
            "O2'	-0.8580205424500587	-3.993215463720635	-2.433981154207261	",
            "C1'	-1.173331415029909	-3.6771389150868092	-0.04640085837705188	",
            "N9	-1.442188486269906	-2.235353747964258	0.020295521656999993	",
            "C8	-2.706268697085713	-1.696982361004539	0.001362209032653272	",
            "N7	-2.71680057137561	-0.39855729390229927	0.0032128155509536516	",
            "C5	-1.3756142847726913	-0.042009331473601745	-0.000897551368695404	",
            "C6	-0.7712135954292816	1.2458784746348148	5.551115123125783e-17	",
            "O6	-1.3086835252802969	2.359190683278898	-0.000024289456141302068"	,
            "N1	0.6127959235382229	1.1662184504382498	0.0009653767877970676	",
            "C2	1.3233003879190337	-2.6064220226551527e-16	1.1102230246251565e-16	",
            "N2	2.6533117111739957	0.14424626336191518	0.0013767787435607914	",
            "N3	0.7802809496316048	-1.207435425966331	0.0007627342320594144	",
            "C4	-0.5695493808868924	-1.1626521676331354	-0.0008305596511674063	"]

TEMPL_U_A3=["P	-3.4108592869210685	-4.517162988819271	0.5562381949200255"	,
            "OP1	-3.7191389836428503	-5.786579036509587	1.248746336717235	",
            "OP2	-4.239429770531759	-3.3186260237650864	0.8609907126911589	",
            "O5'	-1.8890541000380705	-4.135239577722408	0.8353877627723574	",
            "C5'	-0.8575184190542828	-5.0719329129330015	0.5653345557383282	",
            "C4'	0.5052214170170336	-4.432959261117876	0.619977135018273	",
            "O4'	0.6501165358950624	-3.4611965993852665	-0.44351745066972115	",
            "C3'	0.8302628112988073	-3.6381851772779865	1.8735864232974486	",
            "O3'	1.143006097548064	-4.441621997711289	2.9915282431065315	",
            "C2'	1.9654111142915451	-2.750296455778054	1.3962972568103715	",
            "O2'	3.1653084083921925	-3.492473929642616	1.2603594736227435	",
            "C1'	1.4771439762073988	-2.4009628232998153	-0.005446733755194222	",
            "N1	0.6864048198835953	-1.1605549518096312	-0.0008751911805894297	",
            "C2	1.416572908662154	2.42861286636753e-16	0.	                ",
            "O2	2.6341911402779115	-0.004372986086491115	-0.004440611400061023	",
            "N3	0.6751461924108041	1.1406627052334923	0.00500173151590505	",
            "C4	-0.7024366260005631	1.2198432653453857	0.	                ",
            "O4	-1.2275424374403572	2.330578404313132	-0.0053233311434434105	",
            "C5	-1.388941825076481	-0.036082070278461775	0.0017784768363785508	",
            "C6	-0.6867454698795099	-1.163868948490795	-0.005905017171683236	"]

TEMPL_U_A2=["P	-2.7611363856512754	-5.024803535972864	0.25216921399131154"	,
            "OP1	-2.5788588137671224	-6.482579139880025	0.42377974817010416	",
            "OP2	-3.4116780262148105	-4.267891840722175	1.351638749488147	",
            "O5'	-1.2979370905924534	-4.49388135930917	-0.010472110377206523	",
            "C5'	-0.4049554223062136	-5.217389914340272	-0.8425635181573491	",
            "C4'	0.9756136600304016	-4.613416188382724	-0.8082743471380562	",
            "O4'	0.8864402045950766	-3.1983260270932172	-1.123772255637246	",
            "C3'	1.6859214059829326	-4.7004611666667016	0.545563190307034	",
            "O3'	3.085310976520603	-4.8274671848235	0.30739245066349175	",
            "C2'	1.4106083370678233	-3.334505175316906	1.169876367951185	",
            "O2'	2.3822012315556504	-2.93696141834597	2.113961750040221	",
            "C1'	1.442999517459163	-2.43544466482596	-0.06139249379616396	",
            "N1	0.6821482331778264	-1.17961324525664	0.021449336398147167	",
            "C2	1.4208806052742262	-1.6653345369377348e-16	0.	                ",
            "O2	2.6389061219215733	0.04397450404505032	-0.004252503962666965	",
            "N3	0.6753393101544831	1.1401916013980016	-0.003047847213253352	",
            "C4	-0.6922005282532089	1.228251245930738	1.1102230246251565e-16	",
            "O4	-1.1851573824275636	2.3464973509939906	0.0014793354567436134	",
            "C5	-1.3919729062484048	-0.02304388997660939	-0.007218161092456377	",
            "C6	-0.6941947141049091	-1.1657857120955053	-0.011183328092437023	"]

TEMPL_U_H3=["P	-1.7355988911412537	-4.3209119709111725	-3.7766509386014353"	,
            "OP1	-1.7104041608153184	-5.744814546031059	-4.1243284934288305	",
            "OP2	-2.9923611855242926	-3.654093785397554	-3.4418404804532416	",
            "O5'	-0.8006099032524377	-4.064002508794457	-2.537307918771351	",
            "C5'	0.3930034138933029	-4.797734071289507	-2.3837949117298987	",
            "C4'	1.1326847270487406	-4.35850677846465	-1.1599477234721496	",
            "O4'	1.4569508517099983	-2.965336984935253	-1.2733955387636953	",
            "C3'	0.37487430256709725	-4.455635756877584	0.14458679968138166	",
            "O3'	0.4249692881549506	-5.775528153743262	0.6518939582304455	",
            "C2'	1.0939883506883095	-3.4337525105740054	1.0215996939530625	",
            "O2'	2.270243563051569	-3.9975430177198006	1.5747334385759668	",
            "C1'	1.5263697235609592	-2.384666204880422	-0.0011438083968420276	",
            "N1	0.694176894349457	-1.1704100573037521	0.0026115985344797865	",
            "C2	1.4024956625007214	1.942890293094024e-16	2.7755575615628914e-17	",
            "O2	2.6155329256367335	-0.0008791984114012164	-0.005729332740309512	",
            "N3	0.6630061502949749	1.148601952475293	-0.004220913130012549	",
            "C4	-0.7075625566622041	1.2281104639823608	1.1102230246251565e-16	",
            "O4	-1.239377867475178	2.3369380265508344	0.0019777950752308815	",
            "C5	-1.3796259542197835	-0.03474816421120462	0.00093533974016341	",
            "C6	-0.6724901962631535	-1.1715541949426995	0.0006739748553746261	"]

TEMPL_U_H2=["P	-2.440288274724436	-5.120728126985013	-1.3427939682998822	",
            "OP1	-2.6958668010439757	-6.586211304036249	-1.332038752628067	",
            "OP2	-3.3635015037228313	-4.141245131167439	-0.7014887408873898	",
            "O5'	-1.0135855870778672	-4.814576111355766	-0.7155449074092257	",
            "C5'	0.18015359764724415	-5.344560491139952	-1.282441120164789	",
            "C4'	1.3773901940639801	-4.61751603412549	-0.7436898884028424	",
            "O4'	1.2679004217915757	-3.211487386636175	-1.0949525140935195	",
            "C3'	1.5133785008870388	-4.675699344544314	0.7791088122782762	",
            "O3'	2.854398868381203	-4.91360295978817	1.1452812358982405	",
            "C2'	1.0978040554066584	-3.2859852212476293	1.235237671016024	",
            "O2'	1.7320489762500975	-2.8510702964615877	2.41539884161208	",
            "C1'	1.4905495703290352	-2.4208520617829956	0.04878178186417659	",
            "N1	0.6990776725914566	-1.1840795087449918	-0.020844988443884493	",
            "C2	1.4063733698970404	1.6653345369377348e-16	-1.1102230246251565e-16	",
            "O2	2.6160622072156934	0.011604582676462583	-0.004387542313101678	",
            "N3	0.6595875666764082	1.153856148496122	0.0026367946100128714	",
            "C4	-0.7180916291940155	1.2383551460049869	0.	                ",
            "O4	-1.2608572865973229	2.3488510829536686	-0.005405105366854457	",
            "C5	-1.3755915172934539	-0.03406456675421041	0.007481425734991665	",
            "C6	-0.6713554626774282	-1.1740672190019117	0.010726768098886785	"]

########################### CG TEMPLATES ###############################


CGTEMPL_A_A3 = np.array([
    [  5.437,-1.755,0.625],
    [  6.237,-1.159,0.558],
    [  4.849,-0.999,0.336],
    [  6.944,-6.161,2.808],
    [  3.055,-8.587,3.037]
])
CGTEMPL_A_A2 = np.array([
    [  5.437,-1.754,0.625],
    [  6.237,-1.158,0.558],
    [  4.850,-0.998,0.336],
    [  6.944,-6.161,2.806],
    [  3.728,-8.759,2.684]
])
CGTEMPL_A_S3 = np.array([
    [  5.440,-1.754,0.624],
    [  6.239,-1.157,0.558],
    [  4.851,-0.999,0.336],
    [  7.939,-5.059,1.938],
    [  9.025,-2.212,5.758]
])
CGTEMPL_A_S2 = np.array([
    [  5.435,-1.755,0.626],
    [  6.235,-1.159,0.559],
    [  4.848,-1.000,0.336],
    [  7.929,-5.061,1.946],
    [  10.408,-1.993,2.391]
])
CGTEMPL_A_H3 = np.array([
    [  5.437,-1.754,0.626],
    [  6.238,-1.158,0.559],
    [  4.850,-0.998,0.336],
    [  6.940,-6.157,2.816],
    [  5.012,-8.353,-1.597]
])
CGTEMPL_A_H2 = np.array([
    [  5.437,-1.754,0.626],
    [  6.237,-1.158,0.559],
    [  4.849,-0.998,0.336],
    [  6.943,-6.157,2.814],
    [  4.832,-9.396,0.227]
])
CGTEMPL_U_A3 = np.array([
    [  5.437,-1.755,0.625],
    [  6.237,-1.159,0.558],
    [  4.849,-0.999,0.336],
    [  6.944,-6.161,2.808],
    [  3.055,-8.587,3.037]
])
CGTEMPL_U_A2 = np.array([
    [  5.437,-1.754,0.625],
    [  6.237,-1.158,0.558],
    [  4.850,-0.998,0.336],
    [  6.944,-6.161,2.806],
    [  3.728,-8.759,2.684]
])
CGTEMPL_U_S3 = np.array([
    [  5.440,-1.754,0.624],
    [  6.239,-1.157,0.558],
    [  4.851,-0.999,0.336],
    [  7.939,-5.059,1.938],
    [  9.025,-2.212,5.758]
])
CGTEMPL_U_S2 = np.array([
    [  5.435,-1.755,0.626],
    [  6.235,-1.159,0.559],
    [  4.848,-1.000,0.336],
    [  7.929,-5.061,1.946],
    [  10.408,-1.993,2.391]
])
CGTEMPL_U_H3 = np.array([
    [  5.437,-1.754,0.626],
    [  6.238,-1.158,0.559],
    [  4.850,-0.998,0.336],
    [  6.940,-6.157,2.816],
    [  5.012,-8.353,-1.597]
])
CGTEMPL_U_H2 = np.array([
    [  5.437,-1.754,0.626],
    [  6.237,-1.158,0.559],
    [  4.849,-0.998,0.336],
    [  6.943,-6.157,2.814],
    [  4.832,-9.396,0.227]
])
CGTEMPL_C_A3 = np.array([
    [  5.437,-1.755,0.625],
    [  6.237,-1.159,0.558],
    [  4.849,-0.999,0.336],
    [  6.944,-6.161,2.808],
    [  3.055,-8.587,3.037]
])
CGTEMPL_C_A2 = np.array([
    [  5.437,-1.754,0.625],
    [  6.237,-1.158,0.558],
    [  4.850,-0.998,0.336],
    [  6.944,-6.161,2.806],
    [  3.728,-8.759,2.684]
])
CGTEMPL_C_S3 = np.array([
    [  5.440,-1.754,0.624],
    [  6.239,-1.157,0.558],
    [  4.851,-0.999,0.336],
    [  7.939,-5.059,1.938],
    [  9.025,-2.212,5.758]
])
CGTEMPL_C_S2 = np.array([
    [  5.435,-1.755,0.626],
    [  6.235,-1.159,0.559],
    [  4.848,-1.000,0.336],
    [  7.929,-5.061,1.946],
    [  10.408,-1.993,2.391]
])
CGTEMPL_C_H3 = np.array([
    [  5.437,-1.754,0.626],
    [  6.238,-1.158,0.559],
    [  4.850,-0.998,0.336],
    [  6.940,-6.157,2.816],
    [  5.012,-8.353,-1.597]
])
CGTEMPL_C_H2 = np.array([
    [  5.437,-1.754,0.626],
    [  6.237,-1.158,0.559],
    [  4.849,-0.998,0.336],
    [  6.943,-6.157,2.814],
    [  4.832,-9.396,0.227]
])
CGTEMPL_G_A3 = np.array([
    [  5.437,-1.755,0.625],
    [  6.237,-1.159,0.558],
    [  4.849,-0.999,0.336],
    [  6.944,-6.161,2.808],
    [  3.055,-8.587,3.037]
])
CGTEMPL_G_A2 = np.array([
    [  5.437,-1.754,0.625],
    [  6.237,-1.158,0.558],
    [  4.850,-0.998,0.336],
    [  6.944,-6.161,2.806],
    [  3.728,-8.759,2.684]
])
CGTEMPL_G_S3 = np.array([
    [  5.440,-1.754,0.624],
    [  6.239,-1.157,0.558],
    [  4.851,-0.999,0.336],
    [  7.939,-5.059,1.938],
    [  9.025,-2.212,5.758]
])
CGTEMPL_G_S2 = np.array([
    [  5.435,-1.755,0.626],
    [  6.235,-1.159,0.559],
    [  4.848,-1.000,0.336],
    [  7.929,-5.061,1.946],
    [  10.408,-1.993,2.391]
])
CGTEMPL_G_H3 = np.array([
    [  5.437,-1.754,0.626],
    [  6.238,-1.158,0.559],
    [  4.850,-0.998,0.336],
    [  6.940,-6.157,2.816],
    [  5.012,-8.353,-1.597]
])
CGTEMPL_G_H2 = np.array([
    [  5.437,-1.754,0.626],
    [  6.237,-1.158,0.559],
    [  4.849,-0.998,0.336],
    [  6.943,-6.157,2.814],
    [  4.832,-9.396,0.227]
])

TEMPLATES=[
    [[TEMPL_A_A3,TEMPL_A_H3,TEMPL_A_S3],[TEMPL_A_A2,TEMPL_A_H2,TEMPL_A_S2]],
    [[TEMPL_U_A3,TEMPL_U_H3],[TEMPL_U_A2,TEMPL_U_H2]],
    [[TEMPL_G_A3,TEMPL_G_H3,TEMPL_G_S3],[TEMPL_G_A2,TEMPL_G_H2,TEMPL_G_S2]],
    [[TEMPL_C_A3,TEMPL_C_H3],[TEMPL_C_A2,TEMPL_C_H2]]
]

CGTEMPLATES=[
    [[CGTEMPL_A_A3,CGTEMPL_A_H3,CGTEMPL_A_S3],[CGTEMPL_A_A2,CGTEMPL_A_H2,CGTEMPL_A_S2]],
    [[CGTEMPL_U_A3,CGTEMPL_U_H3],[CGTEMPL_U_A2,CGTEMPL_U_H2]],
    [[CGTEMPL_G_A3,CGTEMPL_G_H3,CGTEMPL_G_S3],[CGTEMPL_G_A2,CGTEMPL_G_H2,CGTEMPL_G_S2]],
    [[CGTEMPL_C_A3,CGTEMPL_C_H3],[CGTEMPL_C_A2,CGTEMPL_C_H2]]
]


#######################################


def read_coords(filename, pdbdata, coords):
    alldata=[]
    if filename=="":
        print("File not found!")
        exit(1)
    for line in open(filename):
        nam=line[:4]
        if(nam.strip()=="ATOM"):
            alldata.append(line)
    currnt=int(alldata[0][22:26].strip())
    ntcoord,ntline=[],[]
    for atom in alldata:
        thisnt=int(atom[22:26].strip())
        if thisnt!=currnt:
            currnt=thisnt
            coords.append(ntcoord)
            pdbdata.append(ntline)
            ntcoord,ntline=[],[]
        ntcoord.append(np.array([float(atom[30:38].strip()), float(atom[38:46].strip()), float(atom[46:54].strip())]) )
        ntline.append(atom)
    coords.append(ntcoord)
    pdbdata.append(ntline)

def center_vec(vecs):
    #we assume that the vectors are the atoms of a cg nucleotide
    cmvec=vecs[0]
    cvecs=[]
    for v in vecs:
        cvecs.append(v-cmvec)
    xvec=cvecs[1]/sqrt(np.dot(cvecs[1],cvecs[1]))
    yvec=cvecs[2]/sqrt(np.dot(cvecs[2],cvecs[2]))
    zvec=np.cross(xvec,yvec)
    zvec=zvec/sqrt(np.dot(zvec,zvec))
    return [cvecs,cmvec,np.array([xvec,yvec,zvec])]
    
def align_on_basis(cgnt, basis):
    ccg=center_vec(cgnt)
    rot_vec=[]
    for av in ccg[0]:
        aa=np.dot(av,ccg[2][0])
        bb=np.dot(av,ccg[2][1])
        cc=np.dot(av,ccg[2][2])
        rot_av=aa*basis[0]+bb*basis[1]+cc*basis[2]
        rot_vec.append(rot_av)
    return [rot_vec,ccg]

def get_rmsd(v1,v2):
    rmsdv=0
    for av in range(0,len(v1)):
        rmsdv=rmsdv+np.dot(v1[av]-v2[av],v1[av]-v2[av])
    rmsdv=sqrt(rmsdv/float(len(v1)))
    return rmsdv

def align_and_displace(atom, cgnt, ntdata):
    #        NEWCOORD=align_and_displace(SELNT,SELCG,NTTBM)    
    rot_align_av=[]
    #for av in atnt:
    
    dav=atom-cgnt[1][1]
    aa=np.dot(dav,cgnt[1][2][0])
    bb=np.dot(dav,cgnt[1][2][1])
    cc=np.dot(dav,cgnt[1][2][2])
    rot_at=aa*ntdata[2][0]+bb*ntdata[2][1]+cc*ntdata[2][2]+ntdata[1]
    #rot_align_av.append(rot_av)
    return rot_at


def perform_brute_backmapping(cgntdata):
    cline=cgntdata[0]
    xline=cgntdata[1]
    yline=cgntdata[2]
    basetyp=cline[17:20].strip()
    resind=int(cline[22:26].strip())
    chain=cline[21].strip()
    puck="3"
    glyc="A"
    temppuck="X"
    tempglyc="X"
    if(len(cline)>=57):
        temppuck=cline[57]
        tempglyc=cline[56]
    if((temppuck=="3" or temppuck=="2") and (tempglyc=="A" or tempglyc=="H" or tempglyc=="S")):
        puck=temppuck
        glyc=tempglyc
    CM=np.array([float(cline[30:38].strip()), float(cline[38:46].strip()), float(cline[46:54].strip())])
    rXV=[float(xline[30:38].strip())-CM[0], float(xline[38:46].strip())-CM[1], float(xline[46:54].strip())-CM[2]]
    rYV=[float(yline[30:38].strip())-CM[0], float(yline[38:46].strip())-CM[1], float(yline[46:54].strip())-CM[2]]
    mXV=sqrt(rXV[0]*rXV[0]+rXV[1]*rXV[1]+rXV[2]*rXV[2])
    mYV=sqrt(rYV[0]*rYV[0]+rYV[1]*rYV[1]+rYV[2]*rYV[2])
    XV=np.array([rXV[0]/mXV,rXV[1]/mXV,rXV[2]/mXV])
    YV=np.array([rYV[0]/mYV,rYV[1]/mYV,rYV[2]/mYV])
    rZV=[XV[1]*YV[2]-XV[2]*YV[1], XV[2]*YV[0]-XV[0]*YV[2], XV[0]*YV[1]-XV[1]*YV[0]]
    mZV=sqrt(rZV[0]*rZV[0]+rZV[1]*rZV[1]+rZV[2]*rZV[2])
    ZV=np.array([rZV[0]/mZV,rZV[1]/mZV,rZV[2]/mZV])
    cpuck,cglyc,cbase=-10,-10,-10
    if(puck=="3"):
        cpuck=0
    if(puck=="2"):
        cpuck=1
    if(glyc=="A"):
        cglyc=0
    if(glyc=="H"):
        cglyc=1
    if(glyc=="S"):
        cglyc=2
    if(basetyp=="A"):
        cbase=0
    if(basetyp=="U"):
        cbase=1
    if(basetyp=="G"):
        cbase=2
    if(basetyp=="C"):
        cbase=3
    atoutdata,atcoords=[],[]
    COUNTAT=0
    
    for resline in TEMPLATES[cbase][cpuck][cglyc]:
        reslist=resline.split()
        attype=reslist[0].strip()
        atx=float(reslist[1].strip())
        aty=float(reslist[2].strip())
        atz=float(reslist[3].strip())
        newx=atx*XV[0]+aty*YV[0]+atz*ZV[0]+CM[0]
        newy=atx*XV[1]+aty*YV[1]+atz*ZV[1]+CM[1]
        newz=atx*XV[2]+aty*YV[2]+atz*ZV[2]+CM[2]
        strX=("%0.3f" % newx).rjust(7)
        strY=("%0.3f" % newy).rjust(7)
        strZ=("%0.3f" % newz).rjust(7)
        if(len(strX)>6):
            strX=("%0.2f" % newx).rjust(7)
        if(len(strY)>6):
            strY=("%0.2f" % newy).rjust(7)
        if(len(strZ)>6):
            strZ=("%0.2f" % newz).rjust(7)
        record="ATOM  "
        atindex='{:5}'.format(COUNTAT)
        atname='{:4}'.format(attype)
        resname='{:3}'.format(basetyp)
        chindex=chain
        resindex='{:4}'.format(resind)
        xpos,ypos,zpos='{:8.3f}'.format(newx),'{:8.3f}'.format(newy),'{:8.3f}'.format(newz)
        line=record+atindex+" "+atname+" "+resname+" "+chindex+resindex+"    "+xpos+ypos+zpos+"  1.00  0.00"
        atoutdata.append(line)
        atcoords.append(np.array([newx,newy,newz]))
        COUNTAT=COUNTAT+1
    #now, the atoms of the cg template must also be centered and aligned
    cgoutcoords=[]
    cgnt=CGTEMPLATES[cbase][cpuck][cglyc]
    cg0=CGTEMPLATES[cbase][cpuck][cglyc][0]
    cgxV,cgyV=cgnt[1]-cg0,cgnt[2]-cg0
    cgxV,cgyV=cgxV/np.sqrt(np.dot(cgxV,cgxV)),cgyV/np.sqrt(np.dot(cgyV,cgyV))
    cgzV=np.cross(cgxV,cgyV)
    cgzV=cgzV/np.sqrt(np.dot(cgzV,cgzV))
    
    for cgat in cgnt:
        centered=cgat-cg0
        cgx,cgy,cgz=np.dot(centered,cgxV),np.dot(centered,cgyV),np.dot(centered,cgzV)
        newcgpos=cgx*XV+cgy*YV+cgz*ZV+CM
        cgoutcoords.append(newcgpos)
    return atoutdata,atcoords,cgoutcoords

########################################################################################################################
DATACGTEMPL,CGTEMPL=[],[]
DATACG2BM,CG2BM=[],[]
DATAATTEMPL,ATTEMPL=[],[]
read_coords(args.input, DATACG2BM, CG2BM)
if args.atreference!="" and args.cgreference!="":
    refflag=True
    read_coords(args.atreference, DATAATTEMPL, ATTEMPL)
    read_coords(args.cgreference, DATACGTEMPL, CGTEMPL)


#### we do cg of reference structure ####

#compare nucleotides
if refflag:
    if len(DATACG2BM) != len(DATACGTEMPL) or len(DATACG2BM) != len(DATAATTEMPL):
        print("Number of nucleotides does not match between structures!")
        exit(1)

ATIND=0
OUTFILE=open(args.output,"w")
for nt in range(0,len(DATACG2BM)):
    CHAIN=0

    NTTBM=center_vec(CG2BM[nt]) #gets the centered vectors, the displacement and the basis, where the center is the DATACG2BM base - MOVES NT TO THE ORIGIN
    DATAATNTBBM,ATNTBBM,CGNTBBM=perform_brute_backmapping(DATACG2BM[nt])
    NTCGBBM=align_on_basis(CGNTBBM, NTTBM[2])
    rmsdbbm=get_rmsd(NTCGBBM[0],NTTBM[0])
    rmsdtem=rmsdbbm+1
    if refflag:
        NTCGTEM=align_on_basis(CGTEMPL[nt], NTTBM[2]) #centers and aligns vectors with basis.  NTTBM[2] is the basis
        rmsdtem=get_rmsd(NTCGTEM[0],NTTBM[0]) #NTTBM[0] is the set of centered vectors

    SELNT=ATNTBBM
    SELLINE=DATAATNTBBM
    SELCG=NTCGBBM
    if refflag and rmsdtem<rmsdbbm:
        SELNT=ATTEMPL[nt]
        SELLINE=DATAATTEMPL[nt]
        SELCG=NTCGTEM
        
    
    for atom in range(0,len(SELNT)):
        atindex='{:>5}'.format(ATIND)
        atname='{:>4}'.format(SELLINE[atom][12:16].strip())
        resname='{:>3}'.format(SELLINE[atom][17:20].strip())
        resindex='{:>4}'.format(nt)
        NEWCOORD=align_and_displace(SELNT[atom], SELCG, NTTBM)
        newx,newy,newz=NEWCOORD[0],NEWCOORD[1],NEWCOORD[2]
        xpos,ypos,zpos='{:8.3f}'.format(newx),'{:8.3f}'.format(newy),'{:8.3f}'.format(newz)
        NEWLINE=SELLINE[atom][0:6]+atindex+" "+atname+" "+resname+" "+str(CHAIN)+resindex+SELLINE[atom][26:30]+xpos+ypos+zpos+SELLINE[atom][54:56]
        #SELLINE[atom][11:21]+str(CHAIN)+resindex+SELLINE[atom][26:30]+xpos+ypos+zpos+SELLINE[atom][54:56]
        ATIND=ATIND+1
        OUTFILE.write(NEWLINE.strip()+"\n")
OUTFILE.close()
